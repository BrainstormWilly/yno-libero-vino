name: Deploy to Heroku

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed
  workflow_dispatch:  # Keep manual trigger option

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    # Only deploy if CI passed (or manual trigger)
    if: |
      (github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'main') ||
      github.event_name == 'workflow_dispatch'
    environment:
      name: production
      url: https://yno-libero-vino.herokuapp.com
    
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch || github.ref }}
          fetch-depth: 0  # Fetch full history for Heroku deployment
      
      - name: Verify secrets are set
        run: |
          if [ -z "${{ secrets.HEROKU_API_KEY }}" ]; then
            echo "❌ HEROKU_API_KEY is not set"
            exit 1
          fi
          if [ -z "${{ secrets.HEROKU_APP_NAME }}" ]; then
            echo "❌ HEROKU_APP_NAME is not set"
            exit 1
          fi
          if [ -z "${{ secrets.HEROKU_EMAIL }}" ]; then
            echo "❌ HEROKU_EMAIL is not set"
            exit 1
          fi
          echo "✅ All secrets are set"
      
      - name: Install Heroku CLI
        run: |
          curl https://cli-assets.heroku.com/install.sh | sh
          heroku --version
      
      - name: Configure Git for Heroku
        run: |
          git config --global user.email "${{ secrets.HEROKU_EMAIL }}"
          git config --global user.name "GitHub Actions"
      
      - name: Deploy to Heroku
        run: |
          git remote add heroku https://git.heroku.com/${{ secrets.HEROKU_APP_NAME }}.git || true
          git push https://:${{ secrets.HEROKU_API_KEY }}@git.heroku.com/${{ secrets.HEROKU_APP_NAME }}.git HEAD:main --force
          
      - name: Health check
        run: |
          echo "Waiting 30 seconds for app to start..."
          sleep 30
          echo "Checking health endpoint..."
          curl -f https://yno-libero-vino.herokuapp.com/health || echo "⚠️ Health check failed, but deployment may still be successful"
        continue-on-error: true

  # Staging deployment - uncomment when staging app is created
  # deploy-staging:
  #   name: Deploy to Staging
  #   runs-on: ubuntu-latest
  #   if: github.ref == 'refs/heads/develop'
  #   environment:
  #     name: staging
  #     url: https://yno-libero-vino-staging.herokuapp.com
  #   
  #   steps:
  #     - uses: actions/checkout@v4
  #     
  #     - name: Deploy to Heroku Staging
  #       uses: akhileshns/heroku-deploy@v3.13.15
  #       with:
  #         heroku_api_key: ${{ secrets.HEROKU_API_KEY }}
  #         heroku_app_name: ${{ secrets.HEROKU_STAGING_APP_NAME }}
  #         heroku_email: ${{ secrets.HEROKU_EMAIL }}

